<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wheel of Fortune</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .wheel-box { position: relative; width: 320px; height: 320px; margin-bottom: 30px; }
        canvas { width: 100%; height: 100%; border-radius: 50%; border: 4px solid #333; transition: transform 5s cubic-bezier(0.1, 0, 0.1, 1); }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; background: #ff4757; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; }
        .ui { width: 85%; max-width: 300px; display: flex; flex-direction: column; gap: 12px; }
        input { padding: 14px; border-radius: 10px; border: 1px solid #333; background: #1e1e1e; color: #fff; font-size: 16px; text-align: center; }
        button { padding: 14px; border-radius: 10px; border: none; background: #f1c40f; color: #000; font-weight: bold; font-size: 16px; cursor: pointer; }
        button:disabled { background: #555; cursor: not-allowed; }
        #res { margin-top: 20px; font-weight: bold; color: #f1c40f; text-align: center; font-size: 18px; }
    </style>
</head>
<body>

<div class="wheel-box">
    <div class="pointer"></div>
    <canvas id="wheel" width="600" height="600"></canvas>
</div>

<div class="ui" id="ui-block">
    <input type="tel" id="phone" placeholder="+7 (___) ___-__-__">
    <button id="spin-btn">ИСПЫТАТЬ УДАЧУ</button>
</div>
<div id="res"></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyHVKj4R_px804AqaApgW2sE1_o0mrC0_ab06-Zt_x0dPd7FMGTYEvaFjpLV2dpOxE/exec";
    
    // Список призов должен СОВПАДАТЬ по порядку с PRIZES_CONFIG в бэкенде
    const prizes = ["Скидка 10%", "Кофе", "Бонус 500₽", "Маска", "Супер-приз"];
    const colors = ["#e74c3c", "#3498db", "#f1c40f", "#2ecc71", "#9b59b6"];

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spin-btn');
    const resDiv = document.getElementById('res');

    function drawWheel() {
        const slice = 360 / prizes.length;
        prizes.forEach((p, i) => {
            ctx.beginPath();
            ctx.fillStyle = colors[i % colors.length];
            ctx.moveTo(300, 300);
            ctx.arc(300, 300, 300, (i * slice) * Math.PI/180, ((i+1) * slice) * Math.PI/180);
            ctx.fill();
            ctx.save();
            ctx.translate(300, 300);
            ctx.rotate((i * slice + slice/2) * Math.PI/180);
            ctx.fillStyle = "#fff"; ctx.font = "24px Arial"; ctx.textAlign = "right";
            ctx.fillText(p, 280, 10);
            ctx.restore();
        });
    }
    drawWheel();

    spinBtn.onclick = async () => {
        const phone = document.getElementById('phone').value.replace(/\D/g, '');
        if (phone.length < 10) return alert("Введите корректный телефон");

        spinBtn.disabled = true;
        const tgData = window.Telegram.WebApp.initDataUnsafe;

        try {
            const resp = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ phone, chat_id: tgData.user?.id || null })
            });
            const data = await resp.json();

            if (data.error) {
                alert("Вы уже участвовали!");
                spinBtn.disabled = false;
                return;
            }

            const slice = 360 / prizes.length;
            // Расчет: полные обороты + доворот до сектора (270 - коррекция на указатель сверху)
            const rotation = 2160 + (360 - (data.index * slice)) - (slice / 2) + 270;
            canvas.style.transform = `rotate(${rotation}deg)`;

            setTimeout(() => {
                resDiv.innerHTML = `ПРИЗ: ${data.label}<br>Инструкция отправлена вам в бот!`;
                document.getElementById('ui-block').style.display = 'none';
                if (window.Telegram.WebApp.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }
            }, 5500);

        } catch (e) {
            alert("Ошибка связи с сервером");
            spinBtn.disabled = false;
        }
    };

    if (window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
    }
</script>
</body>
</html>
