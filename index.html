<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wheel of Fortune</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .wheel-box { position: relative; width: 320px; height: 320px; margin-bottom: 30px; }
        canvas { width: 100%; height: 100%; border-radius: 50%; border: 4px solid #333; transition: transform 0s; }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; background: #ff4757; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; }
        .ui { width: 85%; max-width: 300px; display: flex; flex-direction: column; gap: 12px; }
        input { padding: 14px; border-radius: 10px; border: 1px solid #333; background: #1e1e1e; color: #fff; font-size: 16px; text-align: center; }
        button { padding: 14px; border-radius: 10px; border: none; background: #f1c40f; color: #000; font-weight: bold; font-size: 16px; cursor: pointer; }
        button:disabled { opacity: 0.5; }
        #res { margin-top: 20px; font-weight: bold; color: #f1c40f; text-align: center; }
    </style>
</head>
<body>

<div class="wheel-box">
    <div class="pointer"></div>
    <canvas id="wheel" width="600" height="600"></canvas>
</div>

<div class="ui" id="ui-block">
    <input type="tel" id="phone" placeholder="+7 (___) ___-__-__">
    <button id="spin-btn" disabled>Загрузка...</button>
</div>
<div id="res"></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwlcTCYPt2XCn8tx5odqNYAiiFifiLEdKDyiLbx1iTwE2iH132SUe-_lhPmFOawHPg/exec";
    const tg = window.Telegram.WebApp;
    let prizes = [];
    let currentRotation = 0;

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spin-btn');

    tg.ready();
    tg.expand();

    // Загрузка призов
    async function loadPrizes() {
        try {
            const r = await fetch(GAS_URL);
            prizes = await r.json();
            draw();
            spinBtn.disabled = false;
            spinBtn.innerText = "ИСПЫТАТЬ УДАЧУ";
        } catch(e) { alert("Ошибка загрузки данных"); }
    }

    function draw() {
        const slice = 360 / prizes.length;
        ctx.clearRect(0,0,600,600);
        prizes.forEach((p, i) => {
            ctx.beginPath();
            ctx.fillStyle = p.color;
            ctx.moveTo(300, 300);
            ctx.arc(300, 300, 300, (i * slice) * Math.PI/180, ((i+1) * slice) * Math.PI/180);
            ctx.fill();
            ctx.save();
            ctx.translate(300, 300);
            ctx.rotate((i * slice + slice/2) * Math.PI/180);
            ctx.fillStyle = "#fff"; ctx.font = "bold 24px Arial"; ctx.textAlign = "right";
            ctx.fillText(p.label, 280, 10);
            ctx.restore();
        });
    }

    spinBtn.onclick = async () => {
        const phone = document.getElementById('phone').value.replace(/\D/g, '');
        if (phone.length < 10) return alert("Введите телефон");

        spinBtn.disabled = true;

        // Мгновенная анимация ожидания
        let preRoll = currentRotation;
        const interval = setInterval(() => {
            preRoll += 3;
            canvas.style.transform = `rotate(${preRoll}deg)`;
            currentRotation = preRoll;
        }, 16);

        try {
            const resp = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ phone, chat_id: tg.initDataUnsafe?.user?.id || null })
            });
            const data = await resp.json();
            clearInterval(interval);

            if (data.error) {
                alert(data.error === "already_played" ? "Вы уже участвовали!" : "Ошибка: " + data.details);
                spinBtn.disabled = false;
                return;
            }

            // Финальный рывок
            const slice = 360 / prizes.length;
            const extra = 360 * 5;
            const stopAt = (360 - (data.index * slice)) - (slice / 2) + 270;
            const final = currentRotation + extra + (stopAt - (currentRotation % 360));

            canvas.style.transition = "transform 4s cubic-bezier(0.15, 0, 0.15, 1)";
            canvas.style.transform = `rotate(${final}deg)`;
            currentRotation = final;

            setTimeout(() => {
                document.getElementById('res').innerHTML = `ВЫИГРЫШ: ${data.label}`;
                document.getElementById('ui-block').style.display = 'none';
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            }, 4200);

        } catch (e) {
            clearInterval(interval);
            alert("Сбой связи");
            spinBtn.disabled = false;
        }
    };

    loadPrizes();
</script>
</body>
</html>
