<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wheel of Fortune</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .wheel-box { position: relative; width: 320px; height: 320px; margin-bottom: 30px; }
        canvas { width: 100%; height: 100%; border-radius: 50%; border: 4px solid #333; }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; background: #ff4757; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; }
        .ui { width: 85%; max-width: 300px; display: flex; flex-direction: column; gap: 12px; }
        input { padding: 14px; border-radius: 10px; border: 1px solid #333; background: #1e1e1e; color: #fff; font-size: 16px; text-align: center; }
        button { padding: 14px; border-radius: 10px; border: none; background: #f1c40f; color: #000; font-weight: bold; font-size: 16px; cursor: pointer; }
        button:disabled { opacity: 0.6; }
        #res { margin-top: 20px; font-weight: bold; color: #f1c40f; text-align: center; }
        
        /* Анимация вращения через JS для контроля скорости */
    </style>
</head>
<body>

<div class="wheel-box">
    <div class="pointer"></div>
    <canvas id="wheel" width="600" height="600"></canvas>
</div>

<div class="ui" id="ui-block">
    <input type="tel" id="phone" placeholder="+7 (___) ___-__-__">
    <button id="spin-btn">ИСПЫТАТЬ УДАЧУ</button>
</div>
<div id="res"></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw8vvM5f1GddHUIxLtAf90fUoZbUpGtx76aoJcc8L3DfHKUK6KVopVLp7tI6e4WQ5c/exec";
// 1. Дефолтные призы (пока грузятся основные)
let prizes = [
    { label: "Загрузка...", weight: 1, color: "#333" },
    { label: "...", weight: 1, color: "#444" },
    { label: "Загрузка...", weight: 1, color: "#333" },
    { label: "...", weight: 1, color: "#444" }
];
let currentRotation = 0;

const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spin-btn');

// Рисуем сразу при загрузке страницы
window.onload = () => {
    drawWheel(); // Нарисует серые сектора "Загрузка"
    loadActualPrizes(); // Начнет качать реальные данные
};

async function loadActualPrizes() {
    try {
        const resp = await fetch(GAS_URL);
        const data = await resp.json();
        if (data.length > 0) {
            prizes = data;
            drawWheel(); // Перерисует колесо в нормальные цвета
        }
    } catch (e) {
        console.error("Не удалось подгрузить призы, используем дефолт");
    }
}

function drawWheel() {
    const slice = 360 / prizes.length;
    ctx.clearRect(0,0,600,600);
    prizes.forEach((p, i) => {
        ctx.beginPath();
        ctx.fillStyle = p.color;
        ctx.moveTo(300, 300);
        ctx.arc(300, 300, 300, (i * slice) * Math.PI/180, ((i+1) * slice) * Math.PI/180);
        ctx.fill();
        ctx.save();
        ctx.translate(300, 300);
        ctx.rotate((i * slice + slice/2) * Math.PI/180);
        ctx.fillStyle = "#fff";
        ctx.font = "bold 24px Arial";
        ctx.textAlign = "right";
        ctx.fillText(p.label, 280, 10);
        ctx.restore();
    });
}

spinBtn.onclick = async () => {
    const rawPhone = document.getElementById('phone').value;
    if (rawPhone.replace(/\D/g, '').length < 10) return alert("Введите корректный номер");

    spinBtn.disabled = true;

    // МГНОВЕННО запускаем медленное вращение (для фидбека)
    let preRollAngle = currentRotation;
    const preRoll = setInterval(() => {
        preRollAngle += 2;
        canvas.style.transform = `rotate(${preRollAngle}deg)`;
        currentRotation = preRollAngle;
    }, 16);

    try {
        const tgData = window.Telegram.WebApp.initDataUnsafe;
        const resp = await fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify({ 
                phone: rawPhone, 
                chat_id: tgData.user?.id || null 
            })
        });
        const result = await resp.json();

        clearInterval(preRoll); // Останавливаем "ожидающее" вращение

        if (result.error === "already_played") {
            alert("Вы уже участвовали!");
            spinBtn.disabled = false;
            return;
        }
        
        if (result.error) {
            alert("Ошибка: " + result.error);
            spinBtn.disabled = false;
            return;
        }

        // РАСЧЕТ ФИНАЛЬНОЙ ТОЧКИ (4 полных круга + нужный сектор)
        const slice = 360 / prizes.length;
        const extraSpins = 360 * 4;
        const stopAt = (360 - (result.index * slice)) - (slice / 2) + 270;
        const finalTarget = currentRotation + extraSpins + (stopAt - (currentRotation % 360));

        // Плавная анимация через CSS
        canvas.style.transition = "transform 4s cubic-bezier(0.15, 0, 0.15, 1)";
        canvas.style.transform = `rotate(${finalTarget}deg)`;
        currentRotation = finalTarget;

        setTimeout(() => {
            document.getElementById('res').innerHTML = `<b>УРА! ВАШ ПРИЗ:</b><br>${result.label}`;
            document.getElementById('ui-block').style.display = 'none';
            if (window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }, 4500);

    } catch (e) {
        clearInterval(preRoll);
        alert("Ошибка сервера. Проверьте соединение.");
        spinBtn.disabled = false;
    }
};
</script>
</body>
</html>
