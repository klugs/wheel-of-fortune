<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wheel of Fortune</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .wheel-box { position: relative; width: 320px; height: 320px; margin-bottom: 30px; }
        canvas { width: 100%; height: 100%; border-radius: 50%; border: 4px solid #333; }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; background: #ff4757; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; }
        .ui { width: 85%; max-width: 300px; display: flex; flex-direction: column; gap: 12px; }
        input { padding: 14px; border-radius: 10px; border: 1px solid #333; background: #1e1e1e; color: #fff; font-size: 16px; text-align: center; }
        button { padding: 14px; border-radius: 10px; border: none; background: #f1c40f; color: #000; font-weight: bold; font-size: 16px; cursor: pointer; }
        button:disabled { opacity: 0.6; }
        #res { margin-top: 20px; font-weight: bold; color: #f1c40f; text-align: center; }
        
        /* Анимация вращения через JS для контроля скорости */
    </style>
</head>
<body>

<div class="wheel-box">
    <div class="pointer"></div>
    <canvas id="wheel" width="600" height="600"></canvas>
</div>

<div class="ui" id="ui-block">
    <input type="tel" id="phone" placeholder="+7 (___) ___-__-__">
    <button id="spin-btn">ИСПЫТАТЬ УДАЧУ</button>
</div>
<div id="res"></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwfKR2Mt2yRT6e1fd1SbbOvYfsrf1LMIIfvYLxKeKB4z6xKTVZJLW7dR5qwwkWROWM/exec";
    let prizes = [];
    let currentRotation = 0;
    let isSpinning = false;

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spin-btn');
    const resDiv = document.getElementById('res');

    // 1. ПОДГРУЗКА ПРИЗОВ ПРИ СТАРТЕ
    window.onload = async () => {
        try {
            const resp = await fetch(GAS_URL);
            prizes = await resp.json();
            drawWheel();
        } catch (e) {
            alert("Ошибка загрузки призов");
        }
    };

    function drawWheel() {
        const slice = 360 / prizes.length;
        ctx.clearRect(0,0,600,600);
        prizes.forEach((p, i) => {
            ctx.beginPath();
            ctx.fillStyle = p.color || "#333";
            ctx.moveTo(300, 300);
            ctx.arc(300, 300, 300, (i * slice) * Math.PI/180, ((i+1) * slice) * Math.PI/180);
            ctx.fill();
            ctx.save();
            ctx.translate(300, 300);
            ctx.rotate((i * slice + slice/2) * Math.PI/180);
            ctx.fillStyle = "#fff"; ctx.font = "bold 22px Arial"; ctx.textAlign = "right";
            ctx.fillText(p.label, 280, 10);
            ctx.restore();
        });
    }

    // Функция плавной анимации
    function animateRotation(targetDeg, duration, callback) {
        const start = performance.now();
        const startRotation = currentRotation;
        const diff = targetDeg - startRotation;

        function step(now) {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1);
            // Ease-out cubic
            const ease = 1 - Math.pow(1 - progress, 3);
            
            currentRotation = startRotation + (diff * ease);
            canvas.style.transform = `rotate(${currentRotation}deg)`;

            if (progress < 1) {
                requestAnimationFrame(step);
            } else if (callback) {
                callback();
            }
        }
        requestAnimationFrame(step);
    }

    spinBtn.onclick = async () => {
        const phoneInput = document.getElementById('phone').value;
        if (phoneInput.length < 10) return alert("Введите телефон");

        spinBtn.disabled = true;
        
        // МГНОВЕННЫЙ ЗАПУСК: начинаем медленно вращать (pre-roll)
        let preRollAngle = currentRotation;
        const preRollInterval = setInterval(() => {
            preRollAngle += 2;
            canvas.style.transform = `rotate(${preRollAngle}deg)`;
            currentRotation = preRollAngle;
        }, 16);

        try {
            const tgData = window.Telegram.WebApp.initDataUnsafe;
            const resp = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ phone: phoneInput, chat_id: tgData.user?.id || null })
            });
            const data = await resp.json();

            clearInterval(preRollInterval); // Останавливаем фоновое вращение

            if (data.error) {
                alert("Вы уже участвовали!");
                spinBtn.disabled = false;
                return;
            }

            // РАСЧЕТ ФИНАЛЬНОЙ ТОЧКИ
            const slice = 360 / prizes.length;
            const extraSpins = 360 * 4; // 4 полных круга
            const stopAt = (360 - (data.index * slice)) - (slice / 2) + 270;
            const finalTarget = currentRotation + extraSpins + (stopAt - (currentRotation % 360));

            animateRotation(finalTarget, 4000, () => {
                resDiv.innerHTML = `ПОЗДРАВЛЯЕМ!<br>Ваш приз: ${data.label}`;
                document.getElementById('ui-block').style.display = 'none';
            });

        } catch (e) {
            clearInterval(preRollInterval);
            alert("Ошибка сервера");
            spinBtn.disabled = false;
        }
    };
</script>
</body>
</html>
