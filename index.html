<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ú–µ—á—Ç–∞ –ë—å—é—Ç–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #a67c6d; --dark: #8e5e4e; --gold: #d4af37; --bg: #fffdfa; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg);
            margin: 0; display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow: hidden;
        }

        /* –î–ï–ö–û–† –ü–û–î–õ–û–ñ–ö–ò */
        .bg-decor {
            position: fixed; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .circle { position: absolute; border-radius: 50%; background: var(--primary); opacity: 0.1; }
        .c1 { width: 300px; height: 300px; top: -100px; right: -100px; }
        .c2 { width: 200px; height: 200px; bottom: -50px; left: -50px; background: var(--gold); }
        .leaf { 
            position: absolute; width: 100px; height: 150px; 
            background: url('https://www.transparentpng.com/download/leaves/green-leaves-transparent-background-3.png'); 
            background-size: contain; background-repeat: no-repeat; opacity: 0.15; filter: sepia(1);
        }

        /* –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò */
        #loader {
            position: fixed; inset: 0; background: var(--bg); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .load-logo { width: 200px; height: auto; object-fit: contain; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* –ö–û–ù–¢–ï–ù–¢ */
        .header { text-align: center; margin-top: 20px; z-index: 1; }
        .logo { width: 90px; height: auto; object-fit: contain; }
        h1 { font-family: 'Cormorant Garamond', serif; font-size: 24px; margin: 5px 0; color: var(--dark); }
        .sub { font-family: 'Cormorant Garamond', serif; color: var(--gold); font-size: 20px; font-style: italic; }

        .wheel-wrapper { position: relative; width: 320px; height: 320px; margin: 20px 0; }
        canvas { width: 100%; height: 100%; border-radius: 50%; border: 8px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .pointer { 
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%); 
            width: 30px; height: 40px; background: var(--dark); clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10;
        }

        .ui { width: 85%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; }
        input { padding: 15px; border-radius: 30px; border: 1px solid #ddd; text-align: center; font-size: 16px; background: rgba(255,255,255,0.8); }
        button { 
            padding: 16px; border-radius: 30px; border: none; background: var(--dark); 
            color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

<div id="loader">
    <img src="logo_b.png" class="load-logo">
    <p style="color: var(--dark); font-family: 'Cormorant Garamond';">–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è —Ç–µ–ª–∞...</p>
</div>

<div class="bg-decor">
    <div class="circle c1"></div>
    <div class="circle c2"></div>
    <div class="leaf" style="top: 10%; right: 5%;"></div>
    <div class="leaf" style="bottom: 15%; left: 5%; transform: rotate(180deg);"></div>
</div>

<div class="header">
    <img src="logo_b.png" class="logo">
    <h1>–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è —Ç–µ–ª–∞ –ú–µ—á—Ç–∞ –±—å—é—Ç–∏</h1>
    <div class="sub">–¢–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ –∫ 8 –º–∞—Ä—Ç–∞!üåπ</div>
</div>

<div class="wheel-wrapper">
    <div class="pointer"></div>
    <canvas id="wheel" width="600" height="600"></canvas>
</div>

<div class="ui" id="ui-block">
    <input type="tel" id="phone" placeholder="+7 (999) 000-00-00">
    <button id="spin-btn">–ò–°–ü–´–¢–ê–¢–¨ –£–î–ê–ß–£</button>
</div>
<div id="res" style="margin-top:20px; text-align:center; font-weight:bold; color:var(--dark);"></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz80QMGH34JsU_fZw8Vofs7eeyGR1eE3i9tB5NyD84xI7eiC1Z6SSMq55-Su5Z8QoI/exec";
    const tg = window.Telegram.WebApp;
    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    
    // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–∏–∑—ã, —á—Ç–æ–±—ã –∫–æ–ª–µ—Å–æ –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç—ã–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    let prizes = [
        {label: "–ü–æ–¥–∞—Ä–æ–∫", color: "#a67c6d"}, {label: "–°–∫–∏–¥–∫–∞", color: "#92b6b1"},
        {label: "–ë–æ–Ω—É—Å", color: "#f5e1c8"}, {label: "–£—Å–ª—É–≥–∞", color: "#e8a87c"}
    ];
    let currentRotation = 0;

    tg.ready();
    tg.expand();

    // –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
        try {
            const r = await fetch(GAS_URL);
            const data = await r.json();
            if (data.length > 0) prizes = data;
            draw();
            // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').remove(), 500);
        } catch(e) { 
            console.error("GAS error, using defaults");
            document.getElementById('loader').remove();
            draw();
        }
    }

    function getContrast(hex) {
        const r = parseInt(hex.substr(1,2),16), g = parseInt(hex.substr(3,2),16), b = parseInt(hex.substr(5,2),16);
        return ((r*299)+(g*587)+(b*114))/1000 > 150 ? '#2c2c2c' : '#fff';
    }

    function draw() {
        const slice = 360 / prizes.length;
        ctx.clearRect(0,0,600,600);
        prizes.forEach((p, i) => {
            const ang = (i * slice) * Math.PI/180;
            ctx.beginPath(); ctx.fillStyle = p.color; ctx.moveTo(300, 300);
            ctx.arc(300, 300, 300, ang, ang + (slice * Math.PI/180)); ctx.fill();
            ctx.save(); ctx.translate(300, 300); ctx.rotate(ang + (slice/2) * Math.PI/180);
            ctx.fillStyle = getContrast(p.color); ctx.font = "bold 22px Montserrat";
            ctx.textAlign = "right"; ctx.fillText(p.label, 280, 10); ctx.restore();
        });
    }

    document.getElementById('spin-btn').onclick = async function() {
        const phone = document.getElementById('phone').value.replace(/\D/g, '');
        if (phone.length < 10) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω");

        this.disabled = true;

        // –ú–ì–ù–û–í–ï–ù–ù–´–ô –ó–ê–ü–£–°–ö (Pre-roll)
        // –ö–æ–ª–µ—Å–æ –Ω–∞—á–∏–Ω–∞–µ—Ç –∫—Ä—É—Ç–∏—Ç—å—Å—è –°–†–ê–ó–£, —Å–∫—Ä—ã–≤–∞—è –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Google
        let spinSpeed = 2;
        const preRoll = setInterval(() => {
            currentRotation += spinSpeed;
            if (spinSpeed < 15) spinSpeed += 0.2; // –†–∞–∑–≥–æ–Ω
            canvas.style.transform = `rotate(${currentRotation}deg)`;
        }, 16);

        try {
            const resp = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ phone, chat_id: tg.initDataUnsafe?.user?.id || null })
            });
            const data = await resp.json();
            clearInterval(preRoll); // –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ñ–∞–∑–µ

            if (data.error) {
                alert(data.error === "already_played" ? "–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏!" : "–û—à–∏–±–∫–∞");
                this.disabled = false;
                return;
            }

            // –ü–ª–∞–≤–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –Ω—É–∂–Ω–æ–º –ø—Ä–∏–∑–µ
            const slice = 360 / prizes.length;
            const extra = 360 * 4;
            const stopAt = (360 - (data.index * slice)) - (slice / 2) + 270;
            const final = currentRotation + extra + (stopAt - (currentRotation % 360));

            canvas.style.transition = "transform 4s cubic-bezier(0.1, 0, 0.1, 1)";
            canvas.style.transform = `rotate(${final}deg)`;
            currentRotation = final;

            setTimeout(() => {
                document.getElementById('res').innerHTML = `üéä –í–ê–® –ü–†–ò–ó: ${data.label} üéä`;
                document.getElementById('ui-block').style.display = 'none';
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            }, 4200);

        } catch (e) {
            clearInterval(preRoll);
            alert("–°–±–æ–π —Å–≤—è–∑–∏");
            this.disabled = false;
        }
    };

    loadData();
</script>
</body>
</html>
